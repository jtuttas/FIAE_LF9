<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDO</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="main.js"></script>
</head>

<body>
    <div class="jumbotron">
        <div class="container">
            <h1>Tasks</h1>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html">Tasks</a>
        <a class="navbar-brand" href="priority.html">Priorities</a>
        <a class="navbar-brand" href="project.html">Projects</a>
    </nav>
    <div class="row">
        <div class="col-md-12">
            <button id="create" type="button" class="btn btn-primary btn-lg">Create</button>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-12">


            <table class="table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th>title</th>
                        <th>project</th>
                        <th>date</th>
                        <th>priority</th>
                    </tr>
                </thead>
                <tbody id="body">
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="form" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title" id="exampleModalLongTitle"><strong id="dialogTitle">Edit
                            Todo</strong></span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="form-group">
                            <label for="title" class="col-sm-2 control-label">Title:</label>
                            <div class="col-sm-10">
                                <input type="text" name="title" id="title" class="form-control" value=""
                                    required="required" pattern="" title="">
                            </div>
                            <label for="date" class="col-sm-2 control-label">date:</label>
                            <div class="col-sm-10">
                                <input type="date" name="date" id="date" class="form-control" value=""
                                    required="required" pattern="" title="">
                            </div>
                            <label for="selectedProject" class="col-sm-2 control-label">Project:</label>
                            <div class="col-sm-10">
                                <div class="dropdown">
                                    <button id="selectedProject" class="btn btn-primary dropdown-toggle" type="button"
                                        data-toggle="dropdown">Projects
                                        <span class="caret"></span></button>
                                    <ul id="projects" class="dropdown-menu">
                                    </ul>
                                </div>
                            </div>

                            <label for="selectedPriority" class="col-sm-2 control-label">Priority:</label>
                            <div class="col-sm-10">
                                <div class="dropdown">
                                    <button id="selectedPriority" class="btn btn-primary dropdown-toggle" type="button"
                                        data-toggle="dropdown">Priorities
                                        <span class="caret"></span></button>
                                    <ul id="priorities" class="dropdown-menu">
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="saveChanges" method="update" type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var dataModel;
    var projectModel;
    var priorityModel;
    var selectedPriority = { "id": -1, "description": undefined };
    var selectedProject = { "id": -1, "description": undefined };;

    /**
     * Returns the Project for a given ID (PK)
     */
    function getProject(i) {
        var project = { id: -1, name: "undefined" };
        projectModel.forEach(element => {

            if (element["id"] == i) {
                project = element;
            }
        });
        return project;
    }
    /**
     * Returns the Priority for a given ID (PK)
     */
    function getPriority(i) {
        console.log('getPrioity of ' + i);
        var priority = { id: -1, description: "undefined" };
        priorityModel.forEach(element => {
            if (element["id"] == i) {
                priority = element;
            }
        });
        return priority;
    }

    $(document).ready(function () {
        $("#list").empty();
        var selectedId;
        $.ajaxSetup({
            scriptCharset: "ISO_8859_1",
            contentType: "application/json; charset=ISO_8859_1"
        });
        $.when($.getJSON(server + "/project"), $.getJSON(server + "/priority"), $.getJSON(server + "/todo")).then(function (pro, pri, todo) {
            priorityModel = pri[0];
            projectModel = pro[0];
            dataModel = todo[0];

            priorityModel.push({ id: -1, description: "undefined" })
            projectModel.push({ id: -1, description: "undefined" })
            i = 0;
            $("#projects").empty();
            projectModel.forEach(element => {
                $("#projects").append('<li index="' + i + '" key="' + element["id"] + '"><a href="#">' + element["name"] + '</a></li>');
                i++;
            });
            $("#selectedProject").empty();
            $("#selectedProject").append(selectedProject["name"] + '<span class="caret"></span>');
            $('#projects li').on('click', function () {
                console.log('Selected Index:' + $(this).attr("index"));
                $("#selectedProject").empty();
                $("#selectedProject").append($(this).text() + '<span class="caret"></span>');
                selectedProject = projectModel[$(this).attr("index")];
                console.log('Selected Project:' + JSON.stringify(selectedProject));
            });

            i = 0;
            $("#priorities").empty();
            priorityModel.forEach(element => {
                $("#priorities").append('<li index="' + i + '"  key="' + element["id"] + '"><a href="#">' + element["description"] + '</a></li>');
                i++;
            });
            $("#selectedPriority").empty();
            $("#selectedPriority").append(selectedPriority["description"] + '<span class="caret"></span>');
            $('#priorities li').on('click', function () {
                console.log('Selected Index:' + $(this).attr("index"));
                $("#selectedPriority").empty();
                $("#selectedPriority").append($(this).text() + '<span class="caret"></span>');
                selectedPriority = priorityModel[$(this).attr("index")];
                console.log('Selected Project:' + JSON.stringify(selectedPriority));
            });


            $("#body").empty();
            var i = 0;
            dataModel.forEach(element => {
                console.log('element=' + JSON.stringify(element));
                pri = getPriority(element["priId"]);
                pro = getProject(element["proId"]);
                console.log("Pri=" + JSON.stringify(pri));
                console.log("Pro=" + JSON.stringify(pro));

                $("#body").append('<tr><td><button type="button" index="' + i + '" key="' + element["id"] + '" class="btn btn-warning update">Update</button><button key="' + element["id"] + '" type="button" class="btn btn-danger delete">Delete</button></td><td>' + element["title"] + '</td><td>' + pro["name"] + '</td><td>' + element["date"] + '</td><td>' + pri["description"] + '</td></tr>');
                i++;
            });
            $(".update").click(function (e) {
                console.log('UPDATE id=' + $(this).attr('key') + " index=" + $(this).attr('index'));
                selectedId = $(this).attr('key');
                $("#dialogTitle").text("Edit Todo id=" + $(this).attr('key'));
                $("#saveChanges").text("Save Changes");
                $("#saveChanges").attr("method", "update")
                var index = $(this).attr('index');
                $("#title").val(dataModel[$(this).attr('index')]["title"]);
                $("#date").val(dataModel[$(this).attr('index')]["date"]);
                $("#selectedProject").empty();
                selectedProject = getProject(dataModel[$(this).attr('index')]["proId"]);
                console.log('selectedProIdt=' + dataModel[$(this).attr('index')]["proId"]);
                console.log('selectedProject=' + JSON.stringify(selectedProject));
                $("#selectedProject").append(selectedProject["name"] + '<span class="caret"></span>');


                selectedPriority = getPriority(dataModel[$(this).attr('index')]["priId"]);
                console.log('selectedPriority=' + JSON.stringify(selectedPriority));
                $("#selectedPriority").empty();
                $("#selectedPriority").append(selectedPriority["description"] + '<span class="caret"></span>');
                $('#form').modal('toggle');
            });
            $(".delete").click(function (e) {
                console.log('DELETE id=' + $(this).attr('key'));
                $.ajax({
                    type: "DELETE",
                    url: server + "/todo/" + $(this).attr('key'),
                    dataType: "application/json",
                    success: function (response) {
                        console.log('response: ' + JSON.stringify(response));
                    }
                });
            });

        });


        $("#saveChanges").click(function (e) {
            $('#form').modal('toggle');
            if ($(this).attr("method") == "update") {
                obj = {
                    "title": $("#title").val(),
                }
                if (selectedProject["id"] != -1) {
                    obj["proId"] = selectedProject["id"];
                }
                else {
                    obj["proId"] = null;
                }
                if (selectedPriority["id"] != -1) {
                    obj["priId"] = selectedPriority["id"];
                }
                else {
                    obj["priId"] = null;
                }
                if ($("#date").val() != "") {
                    obj["date"] = $("#date").val();
                }
                console.log('Update...: ' + JSON.stringify(obj));
                $.ajax({
                    type: "PUT",
                    url: server + "/todo/" + selectedId,
                    data: JSON.stringify(obj),
                    dataType: "application/json",
                    success: function (response) {
                        console.log('response: ' + JSON.stringify(response));
                    }
                });
            }
            else {
                obj = {
                    "title": $("#title").val(),
                }
                if (selectedProject["id"] != -1) {
                    obj["proId"] = selectedProject["id"];
                }
                if (selectedPriority["id"] != -1) {
                    obj["priId"] = selectedPriority["id"];
                }
                if ($("#date").val() != "") {
                    obj["date"] = "\"" + $("#date").val() + "\"";
                }
                console.log('Insert...' + JSON.stringify(obj));

                $.ajax({
                    type: "POST",
                    url: server + "/todo",
                    data: JSON.stringify(obj),
                    dataType: "application/json",
                    success: function (response) {
                        console.log('response: ' + JSON.stringify(response));
                    }
                });

            }
        });

        $("#create").click(function (e) {
            console.log('New ..');
            $("#saveChanges").text("Create");
            $("#saveChanges").attr("method", "insert")
            $("#dialogTitle").text("New Project");
            $("#title").val("");
            $("#date").val("");
            $('#form').modal('toggle');

        });
    });    
</script>

</html>